{
    "status": "error",
    "code": "HTTP_400",
    "message": "A automa칞칚o de lembrete de cupom n칚o est치 habilitada para este tenant.",
    "details": "Error: A automa칞칚o de lembrete de cupom n칚o est치 habilitada para este tenant.\n    at /usr/src/app/src/controllers/automationController.js:147:11\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)"
}
URL da solicita칞칚o
https://apivoltaki.towersfy.com/api/automations/test/coupon-reminder
M칠todo da solicita칞칚o
POST
C칩digo de status
400 Bad Request



URL da solicita칞칚o
https://apivoltaki.towersfy.com/api/whatsapp-config/instance
M칠todo da solicita칞칚o
PUT
C칩digo de status
500 Internal Server Erro

{
    "status": "error",
    "code": "HTTP_500",
    "message": "Validation error",
    "details": "Error\n    at Query.run (/usr/src/app/node_modules/sequelize/lib/dialects/postgres/query.js:50:25)\n    at /usr/src/app/node_modules/sequelize/lib/sequelize.js:315:28\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async PostgresQueryInterface.upsert (/usr/src/app/node_modules/sequelize/lib/dialects/abstract/query-interface.js:341:12)\n    at async WhatsappTemplate.upsert (/usr/src/app/node_modules/sequelize/lib/model.js:1533:20)\n    at async /usr/src/app/src/controllers/whatsappConfigController.js:85:5"
}

      validatorArgs: []
    },
    ValidationErrorItem {
      message: 'type must be unique',
      type: 'unique violation',
      path: 'type',
      value: 'COUPON_REMINDER',
      origin: 'DB',
      instance: [WhatsappTemplate],
      validatorKey: 'not_unique',
      validatorName: null,
      validatorArgs: []
    }
  ],
  parent: error: duplicate key value violates unique constraint "whatsapp_templates_tenant_id_type"
      at Parser.parseErrorMessage (/usr/src/app/node_modules/pg-protocol/dist/parser.js:285:98)
      at Parser.handlePacket (/usr/src/app/node_modules/pg-protocol/dist/parser.js:122:29)
      at Parser.parse (/usr/src/app/node_modules/pg-protocol/dist/parser.js:35:38)
      at Socket.<anonymous> (/usr/src/app/node_modules/pg-protocol/dist/index.js:11:42)
      at Socket.emit (node:events:517:28)
      at addChunk (node:internal/streams/readable:368:12)
      at readableAddChunk (node:internal/streams/readable:341:9)
      at Readable.push (node:internal/streams/readable:278:10)
      at TCP.onStreamRead (node:internal/stream_base_commons:190:23) {
    length: 305,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key ("tenantId", type)=(3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd, COUPON_REMINDER) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'whatsapp_templates',
    column: undefined,
    dataType: undefined,
    constraint: 'whatsapp_templates_tenant_id_type',
    file: 'nbtinsert.c',
    line: '663',
    routine: '_bt_check_unique',
    sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";',
    parameters: [
      'b082e400-4335-47d7-a5ee-887af5052a0f',
      '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
      'COUPON_REMINDER',

      false,
      8,
      '游꼣 Roma Pizzaria & Choperia 游꽅\n' +
        'Oi {{nome_cliente}}! 游녦\n' +
        '\n' +
        'Seu cupom especial {{codigo_cupom}} est치 quase vencendo! 游땸\n' +
        'Aproveite antes que expire em {{data_validade}} e garanta aquele sabor incr칤vel da Roma!\n' +
        '\n' +
        '游댠 Dica do chef: use agora e saboreie sua pizza favorita com aquele chope gelado que s칩 a Roma tem!\n' +
        '\n' +
        '游녤 Pe칞a j치 e n칚o perca essa chance!',
      '2025-11-24 21:10:56.915 +00:00',
      '2025-11-24 21:10:56.915 +00:00'
    ]
  },
  original: error: duplicate key value violates unique constraint "whatsapp_templates_tenant_id_type"
      at Parser.parseErrorMessage (/usr/src/app/node_modules/pg-protocol/dist/parser.js:285:98)
      at Parser.handlePacket (/usr/src/app/node_modules/pg-protocol/dist/parser.js:122:29)
      at Parser.parse (/usr/src/app/node_modules/pg-protocol/dist/parser.js:35:38)
      at Socket.<anonymous> (/usr/src/app/node_modules/pg-protocol/dist/index.js:11:42)
      at Socket.emit (node:events:517:28)
      at addChunk (node:internal/streams/readable:368:12)
      at readableAddChunk (node:internal/streams/readable:341:9)
      at Readable.push (node:internal/streams/readable:278:10)
      at TCP.onStreamRead (node:internal/stream_base_commons:190:23) {
    length: 305,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key ("tenantId", type)=(3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd, COUPON_REMINDER) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'whatsapp_templates',
    column: undefined,
    dataType: undefined,
    constraint: 'whatsapp_templates_tenant_id_type',
    file: 'nbtinsert.c',
    line: '663',
    routine: '_bt_check_unique',
    sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";',
    parameters: [
      'b082e400-4335-47d7-a5ee-887af5052a0f',
      '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
      'COUPON_REMINDER',

      false,
      8,
      '游꼣 Roma Pizzaria & Choperia 游꽅\n' +
        'Oi {{nome_cliente}}! 游녦\n' +
        '\n' +
        'Seu cupom especial {{codigo_cupom}} est치 quase vencendo! 游땸\n' +
        'Aproveite antes que expire em {{data_validade}} e garanta aquele sabor incr칤vel da Roma!\n' +
        '\n' +
        '游댠 Dica do chef: use agora e saboreie sua pizza favorita com aquele chope gelado que s칩 a Roma tem!\n' +
        '\n' +
        '游녤 Pe칞a j치 e n칚o perca essa chance!',
      '2025-11-24 21:10:56.915 +00:00',
      '2025-11-24 21:10:56.915 +00:00'
    ]
  },
  fields: {
    tenantId: '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
    type: 'COUPON_REMINDER'
  },
  sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";'
}
[Auth Middleware] Request: PUT /api/whatsapp-config/instance
Executing (default): SELECT "Usuario"."id", "Usuario"."tenantId", "Usuario"."roleId", "Usuario"."name", "Usuario"."email", "Usuario"."passwordHash", "Usuario"."profilePictureUrl", "Usuario"."createdAt", "Usuario"."updatedAt", "role"."id" AS "role.id", "role"."name" AS "role.name", "role"."description" AS "role.description", "role"."isSystemRole" AS "role.isSystemRole", "role"."createdAt" AS "role.createdAt", "role"."updatedAt" AS "role.updatedAt", "tenant"."id" AS "tenant.id", "tenant"."name" AS "tenant.name", "tenant"."address" AS "tenant.address", "tenant"."phone" AS "tenant.phone", "tenant"."email" AS "tenant.email", "tenant"."logoUrl" AS "tenant.logoUrl", "tenant"."primaryColor" AS "tenant.primaryColor", "tenant"."secondaryColor" AS "tenant.secondaryColor", "tenant"."description" AS "tenant.description", "tenant"."website" AS "tenant.website", "tenant"."cnpj" AS "tenant.cnpj", "tenant"."inscricaoEstadual" AS "tenant.inscricaoEstadual", "tenant"."reportPhoneNumber" AS "tenant.reportPhoneNumber", "tenant"."gmb_link" AS "tenant.gmb_link", "tenant"."createdAt" AS "tenant.createdAt", "tenant"."updatedAt" AS "tenant.updatedAt" FROM "usuarios" AS "Usuario" LEFT OUTER JOIN "roles" AS "role" ON "Usuario"."roleId" = "role"."id" LEFT OUTER JOIN "tenants" AS "tenant" ON "Usuario"."tenantId" = "tenant"."id" WHERE "Usuario"."id" = 'bfe6c6f3-bc13-44b7-a796-d7b3ce2353e5';
Executing (default): SELECT "id", "url", "apiKey", "instanceApiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
Executing (default): INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";
Error
    at Query.run (/usr/src/app/node_modules/sequelize/lib/dialects/postgres/query.js:50:25)
    at /usr/src/app/node_modules/sequelize/lib/sequelize.js:315:28
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async PostgresQueryInterface.upsert (/usr/src/app/node_modules/sequelize/lib/dialects/abstract/query-interface.js:341:12)
    at async WhatsappTemplate.upsert (/usr/src/app/node_modules/sequelize/lib/model.js:1533:20)
    at async /usr/src/app/src/controllers/whatsappConfigController.js:85:5 {
  name: 'SequelizeUniqueConstraintError',
  errors: [
    ValidationErrorItem {
      message: 'tenantId must be unique',
      type: 'unique violation',
      path: 'tenantId',
      value: '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
      origin: 'DB',
      instance: [WhatsappTemplate],
      validatorKey: 'not_unique',
      validatorName: null,
      validatorArgs: []
    },
    ValidationErrorItem {
      message: 'type must be unique',
      type: 'unique violation',
      path: 'type',
      value: 'COUPON_REMINDER',
      origin: 'DB',
      instance: [WhatsappTemplate],
      validatorKey: 'not_unique',
      validatorName: null,
      validatorArgs: []
    }
  ],
  parent: error: duplicate key value violates unique constraint "whatsapp_templates_tenant_id_type"
      at Parser.parseErrorMessage (/usr/src/app/node_modules/pg-protocol/dist/parser.js:285:98)
      at Parser.handlePacket (/usr/src/app/node_modules/pg-protocol/dist/parser.js:122:29)
      at Parser.parse (/usr/src/app/node_modules/pg-protocol/dist/parser.js:35:38)
      at Socket.<anonymous> (/usr/src/app/node_modules/pg-protocol/dist/index.js:11:42)
      at Socket.emit (node:events:517:28)
      at addChunk (node:internal/streams/readable:368:12)
      at readableAddChunk (node:internal/streams/readable:341:9)
      at Readable.push (node:internal/streams/readable:278:10)
      at TCP.onStreamRead (node:internal/stream_base_commons:190:23) {
    length: 305,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key ("tenantId", type)=(3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd, COUPON_REMINDER) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'whatsapp_templates',
    column: undefined,
    dataType: undefined,
    constraint: 'whatsapp_templates_tenant_id_type',
    file: 'nbtinsert.c',
    line: '663',
    routine: '_bt_check_unique',
    sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";',
    parameters: [
      '3f6160f6-bf58-464a-abe8-59a7269f1050',
      '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
      'COUPON_REMINDER',

      false,
      8,
      '游꼣 Roma Pizzaria & Choperia 游꽅\n' +
        'Oi {{nome_cliente}}! 游녦\n' +
        '\n' +
        'Seu cupom especial {{codigo_cupom}} est치 quase vencendo! 游땸\n' +
        'Aproveite antes que expire em {{data_validade}} e garanta aquele sabor incr칤vel da Roma!\n' +
        '\n' +
        '游댠 Dica do chef: use agora e saboreie sua pizza favorita com aquele chope gelado que s칩 a Roma tem!\n' +
        '\n' +
        '游녤 Pe칞a j치 e n칚o perca essa chance!',
      '2025-11-24 21:11:09.275 +00:00',
      '2025-11-24 21:11:09.275 +00:00'
    ]
  },
  original: error: duplicate key value violates unique constraint "whatsapp_templates_tenant_id_type"
      at Parser.parseErrorMessage (/usr/src/app/node_modules/pg-protocol/dist/parser.js:285:98)
      at Parser.handlePacket (/usr/src/app/node_modules/pg-protocol/dist/parser.js:122:29)
      at Parser.parse (/usr/src/app/node_modules/pg-protocol/dist/parser.js:35:38)
      at Socket.<anonymous> (/usr/src/app/node_modules/pg-protocol/dist/index.js:11:42)
      at Socket.emit (node:events:517:28)
      at addChunk (node:internal/streams/readable:368:12)
      at readableAddChunk (node:internal/streams/readable:341:9)
      at Readable.push (node:internal/streams/readable:278:10)
      at TCP.onStreamRead (node:internal/stream_base_commons:190:23) {
    length: 305,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key ("tenantId", type)=(3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd, COUPON_REMINDER) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'whatsapp_templates',
    column: undefined,
    dataType: undefined,
    constraint: 'whatsapp_templates_tenant_id_type',
    file: 'nbtinsert.c',
    line: '663',
    routine: '_bt_check_unique',
    sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";',
    parameters: [
      '3f6160f6-bf58-464a-abe8-59a7269f1050',
      '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
      'COUPON_REMINDER',

      false,
      8,
      '游꼣 Roma Pizzaria & Choperia 游꽅\n' +
        'Oi {{nome_cliente}}! 游녦\n' +
        '\n' +
        'Seu cupom especial {{codigo_cupom}} est치 quase vencendo! 游땸\n' +
        'Aproveite antes que expire em {{data_validade}} e garanta aquele sabor incr칤vel da Roma!\n' +
        '\n' +
        '游댠 Dica do chef: use agora e saboreie sua pizza favorita com aquele chope gelado que s칩 a Roma tem!\n' +
        '\n' +
        '游녤 Pe칞a j치 e n칚o perca essa chance!',
      '2025-11-24 21:11:09.275 +00:00',
      '2025-11-24 21:11:09.275 +00:00'
    ]
  },
  fields: {
    tenantId: '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd',
    type: 'COUPON_REMINDER'
  },
  sql: 'INSERT INTO "whatsapp_templates" ("id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8) ON CONFLICT ("id") DO UPDATE SET "tenantId"=EXCLUDED."tenantId","type"=EXCLUDED."type","isEnabled"=EXCLUDED."isEnabled","daysBefore"=EXCLUDED."daysBefore","message"=EXCLUDED."message","updatedAt"=EXCLUDED."updatedAt" RETURNING "id","tenantId","type","isEnabled","daysBefore","message","createdAt","updatedAt";'
}