Postgres is up - executing command
Server.js is being executed!
API_KEY_ENCRYPTION_KEY is not defined in .env. Please set it for security.
Conexão com o banco de dados estabelecida com sucesso (Sequelize).
Server is running on port 5000
Agendador de relatório diário iniciado. A tarefa será executada todos os dias às 8:00.
Agendador de lembrete de cupons iniciado. A tarefa será executada todos os dias às 9:00.
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/survey-templates
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "SurveyTemplate"."id", "SurveyTemplate"."tenantId", "SurveyTemplate"."title", "SurveyTemplate"."description", "SurveyTemplate"."templateData", "SurveyTemplate"."type", "SurveyTemplate"."targetAudience", "SurveyTemplate"."isSystemTemplate", "SurveyTemplate"."createdAt", "SurveyTemplate"."updatedAt", "tenant"."id" AS "tenant.id", "tenant"."name" AS "tenant.name" FROM "survey_templates" AS "SurveyTemplate" LEFT OUTER JOIN "tenants" AS "tenant" ON "SurveyTemplate"."tenantId" = "tenant"."id" WHERE ("SurveyTemplate"."isSystemTemplate" = true OR "SurveyTemplate"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd') ORDER BY "SurveyTemplate"."title" ASC;
[Auth Middleware] Request: GET /api/surveys/stats
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
[Authorize Debug] User Role: Admin, Required: surveys:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: surveys, Action: read
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'surveys' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT count(*) AS "count" FROM "pesquisas" AS "Pesquisa" WHERE "Pesquisa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "Pesquisa"."status" = 'active';
Executing (default): SELECT count(*) AS "count" FROM "respostas" AS "Resposta" WHERE "Resposta"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "Resposta"."createdAt" >= '2025-10-01 00:00:00.000 +00:00';
Executing (default): SELECT count(*) AS "count" FROM "pesquisas" AS "Pesquisa" WHERE "Pesquisa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT count(*) AS "count" FROM "pesquisas" AS "Pesquisa" WHERE "Pesquisa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "Pesquisa"."status" = 'pending';
[Auth Middleware] Request: GET /api/surveys/list?status=all
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
[Authorize Debug] User Role: Admin, Required: surveys:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: surveys, Action: read
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'surveys' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT "Pesquisa"."id", "Pesquisa"."title", "Pesquisa"."description", "Pesquisa"."createdAt", "Pesquisa"."dueDate", "Pesquisa"."status", "Pesquisa"."isOpen", "Pesquisa"."expectedRespondents", "Pesquisa"."askForAttendant", "Pesquisa"."tenantId", "perguntas"."id" AS "perguntas.id", "perguntas"."text" AS "perguntas.text", "perguntas"."type" AS "perguntas.type", "perguntas"."options" AS "perguntas.options", "perguntas"."order" AS "perguntas.order" FROM "pesquisas" AS "Pesquisa" LEFT OUTER JOIN "perguntas" AS "perguntas" ON "Pesquisa"."id" = "perguntas"."pesquisaId" WHERE "Pesquisa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' ORDER BY "Pesquisa"."createdAt" DESC;
Executing (default): SELECT "pesquisaId", COUNT("id") AS "count" FROM "respostas" AS "Resposta" WHERE "Resposta"."pesquisaId" IN ('87d63f62-4bb9-43e5-ab76-9eb004d4d2bb') GROUP BY "pesquisaId";
Executing (default): SELECT "Pesquisa"."id", "Pesquisa"."title", "Pesquisa"."description", "Pesquisa"."createdAt", "Pesquisa"."updatedAt", "Pesquisa"."isOpen", "Pesquisa"."tenantId", "Pesquisa"."askForAttendant", "Pesquisa"."status", "Pesquisa"."recompensaId", "Pesquisa"."roletaId", "perguntas"."id" AS "perguntas.id", "perguntas"."type" AS "perguntas.type", "perguntas"."text" AS "perguntas.text", "perguntas"."options" AS "perguntas.options", "perguntas"."order" AS "perguntas.order", "perguntas"."required" AS "perguntas.required", "tenant"."id" AS "tenant.id", "tenant"."name" AS "tenant.name", "tenant"."logoUrl" AS "tenant.logoUrl", "tenant"."description" AS "tenant.description", "tenant"."primaryColor" AS "tenant.primaryColor", "tenant"."secondaryColor" AS "tenant.secondaryColor", "roleta"."id" AS "roleta.id", "roleta"."nome" AS "roleta.nome", "roleta"."descricao" AS "roleta.descricao", "roleta"."active" AS "roleta.active" FROM "pesquisas" AS "Pesquisa" LEFT OUTER JOIN "perguntas" AS "perguntas" ON "Pesquisa"."id" = "perguntas"."pesquisaId" LEFT OUTER JOIN "tenants" AS "tenant" ON "Pesquisa"."tenantId" = "tenant"."id" LEFT OUTER JOIN "roletas" AS "roleta" ON "Pesquisa"."roletaId" = "roleta"."id" WHERE "Pesquisa"."id" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name" FROM "atendentes" AS "Atendente" WHERE "Atendente"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "Atendente"."status" = 'active' ORDER BY "Atendente"."name" ASC;
Executing (9dc57c75-9ebd-4d67-bbe0-252cea3d2cef): SELECT "Pesquisa"."id", "Pesquisa"."isOpen", "Pesquisa"."tenantId", "Pesquisa"."askForAttendant", "Pesquisa"."title", "perguntas"."id" AS "perguntas.id", "perguntas"."type" AS "perguntas.type", "perguntas"."options" AS "perguntas.options", "perguntas"."required" AS "perguntas.required", "perguntas"."text" AS "perguntas.text" FROM "pesquisas" AS "Pesquisa" LEFT OUTER JOIN "perguntas" AS "perguntas" ON "Pesquisa"."id" = "perguntas"."pesquisaId" WHERE "Pesquisa"."id" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb';
Executing (9dc57c75-9ebd-4d67-bbe0-252cea3d2cef): INSERT INTO "respostas" ("id","perguntaId","pesquisaId","tenantId","atendenteId","respondentSessionId","ratingValue","textValue","createdAt","updatedAt") VALUES ('babeb097-6298-4cdc-bc40-2c5e443fdbf7','cc2c724c-3580-4f94-ab87-5822e4497770','87d63f62-4bb9-43e5-ab76-9eb004d4d2bb','3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd','2a4fd6a3-c581-401d-ba65-9225b56cd850','c1792d28-8dcd-4acd-9606-81ccc7c76e83',5,NULL,'2025-10-13 21:10:05.999 +00:00','2025-10-13 21:10:05.999 +00:00'),('5101d0d0-0a54-4be7-87f5-3c4c7c97170a','2ffb181f-141b-472d-9abd-3c51595c7f29','87d63f62-4bb9-43e5-ab76-9eb004d4d2bb','3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd','2a4fd6a3-c581-401d-ba65-9225b56cd850','c1792d28-8dcd-4acd-9606-81ccc7c76e83',5,NULL,'2025-10-13 21:10:05.999 +00:00','2025-10-13 21:10:05.999 +00:00'),('6254b687-907f-4d99-9184-627ce866118a','5f7acf91-90d6-44cd-963f-6f81effd5e1a','87d63f62-4bb9-43e5-ab76-9eb004d4d2bb','3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd','2a4fd6a3-c581-401d-ba65-9225b56cd850','c1792d28-8dcd-4acd-9606-81ccc7c76e83',5,NULL,'2025-10-13 21:10:05.999 +00:00','2025-10-13 21:10:05.999 +00:00'),('52b2418d-9042-4225-adef-76a567227f81','5e59c492-6d0c-41a4-ba3e-51e8310302ea','87d63f62-4bb9-43e5-ab76-9eb004d4d2bb','3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd','2a4fd6a3-c581-401d-ba65-9225b56cd850','c1792d28-8dcd-4acd-9606-81ccc7c76e83',NULL,NULL,'2025-10-13 21:10:05.999 +00:00','2025-10-13 21:10:05.999 +00:00'),('6a00b096-bbc4-4fc5-b350-d37aa856e61e','d5938446-234d-40c3-967c-050cb336aa06','87d63f62-4bb9-43e5-ab76-9eb004d4d2bb','3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd','2a4fd6a3-c581-401d-ba65-9225b56cd850','c1792d28-8dcd-4acd-9606-81ccc7c76e83',10,NULL,'2025-10-13 21:10:05.999 +00:00','2025-10-13 21:10:05.999 +00:00') RETURNING "id","perguntaId","pesquisaId","tenantId","atendenteId","respondentSessionId","ratingValue","textValue","selectedOption","createdAt","updatedAt";
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "logoUrl", "primaryColor", "secondaryColor", "description" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "logoUrl", "primaryColor", "secondaryColor", "description" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "tenantId" FROM "respostas" AS "Resposta" WHERE "Resposta"."respondentSessionId" = 'c1792d28-8dcd-4acd-9606-81ccc7c76e83' LIMIT 1;
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt" FROM "clients" AS "Client" WHERE "Client"."email" = 'vobolea@email.com';
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt" FROM "clients" AS "Client" WHERE "Client"."phone" = '(35) 99165-7791';
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt" FROM "clients" AS "Client" WHERE "Client"."respondentSessionId" = 'c1792d28-8dcd-4acd-9606-81ccc7c76e83';
Executing (996f3493-8a42-4c72-9219-636641d64c6a): INSERT INTO "clients" ("id","tenantId","name","email","phone","birthDate","respondentSessionId","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9) RETURNING "id","tenantId","name","email","phone","birthDate","respondentSessionId","gender","createdAt","updatedAt";
Executing (default): SELECT "id", "name", "logoUrl", "primaryColor", "secondaryColor", "description" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "Pesquisa"."id", "Pesquisa"."title", "Pesquisa"."description", "Pesquisa"."createdAt", "Pesquisa"."updatedAt", "Pesquisa"."isOpen", "Pesquisa"."tenantId", "Pesquisa"."askForAttendant", "Pesquisa"."status", "Pesquisa"."recompensaId", "Pesquisa"."roletaId", "perguntas"."id" AS "perguntas.id", "perguntas"."type" AS "perguntas.type", "perguntas"."text" AS "perguntas.text", "perguntas"."options" AS "perguntas.options", "perguntas"."order" AS "perguntas.order", "perguntas"."required" AS "perguntas.required", "tenant"."id" AS "tenant.id", "tenant"."name" AS "tenant.name", "tenant"."logoUrl" AS "tenant.logoUrl", "tenant"."description" AS "tenant.description", "tenant"."primaryColor" AS "tenant.primaryColor", "tenant"."secondaryColor" AS "tenant.secondaryColor", "roleta"."id" AS "roleta.id", "roleta"."nome" AS "roleta.nome", "roleta"."descricao" AS "roleta.descricao", "roleta"."active" AS "roleta.active" FROM "pesquisas" AS "Pesquisa" LEFT OUTER JOIN "perguntas" AS "perguntas" ON "Pesquisa"."id" = "perguntas"."pesquisaId" LEFT OUTER JOIN "tenants" AS "tenant" ON "Pesquisa"."tenantId" = "tenant"."id" LEFT OUTER JOIN "roletas" AS "roleta" ON "Pesquisa"."roletaId" = "roleta"."id" WHERE "Pesquisa"."id" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "creatorId", "title", "description", "startDate", "endDate", "isOpen", "askForAttendant", "status", "expectedRespondents", "dueDate", "recompensaId", "roletaId", "createdAt", "updatedAt" FROM "pesquisas" AS "Pesquisa" WHERE "Pesquisa"."id" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb';
Executing (default): SELECT "id", "pesquisaId", "tenantId", "recompensaId", "codigo", "clienteId", "dataGeracao", "dataUtilizacao", "dataValidade", "status", "ultimoContato", "createdAt", "updatedAt", "campanhaId" FROM "cupons" AS "Cupom" WHERE "Cupom"."clienteId" = '90c675d5-c5dc-462b-a68f-a10cfa96334c' AND "Cupom"."pesquisaId" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb' ORDER BY "Cupom"."dataGeracao" DESC LIMIT 1;
Executing (default): SELECT "RoletaPremio"."id", "RoletaPremio"."tenantId", "RoletaPremio"."nome", "RoletaPremio"."descricao", "RoletaPremio"."probabilidade", "RoletaPremio"."recompensaId", "RoletaPremio"."roletaId", "RoletaPremio"."imageUrl", "RoletaPremio"."active", "RoletaPremio"."createdAt", "RoletaPremio"."updatedAt", "recompensa"."id" AS "recompensa.id", "recompensa"."tenantId" AS "recompensa.tenantId", "recompensa"."name" AS "recompensa.name", "recompensa"."description" AS "recompensa.description", "recompensa"."pointsRequired" AS "recompensa.pointsRequired", "recompensa"."type" AS "recompensa.type", "recompensa"."value" AS "recompensa.value", "recompensa"."imageUrl" AS "recompensa.imageUrl", "recompensa"."active" AS "recompensa.active", "recompensa"."createdAt" AS "recompensa.createdAt", "recompensa"."updatedAt" AS "recompensa.updatedAt" FROM "roleta_premios" AS "RoletaPremio" LEFT OUTER JOIN "recompensas" AS "recompensa" ON "RoletaPremio"."recompensaId" = "recompensa"."id" WHERE "RoletaPremio"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "RoletaPremio"."roletaId" = 'f40e45de-fb16-477d-b385-85eb9d38304c' ORDER BY "RoletaPremio"."nome" ASC;
Executing (default): SELECT "id", "tenantId", "creatorId", "title", "description", "startDate", "endDate", "isOpen", "askForAttendant", "status", "expectedRespondents", "dueDate", "recompensaId", "roletaId", "createdAt", "updatedAt" FROM "pesquisas" AS "Pesquisa" WHERE "Pesquisa"."id" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb';
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt" FROM "clients" AS "Client" WHERE "Client"."id" = '90c675d5-c5dc-462b-a68f-a10cfa96334c';
Executing (default): SELECT "id", "pesquisaId", "tenantId", "recompensaId", "codigo", "clienteId", "dataGeracao", "dataUtilizacao", "dataValidade", "status", "ultimoContato", "createdAt", "updatedAt", "campanhaId" FROM "cupons" AS "Cupom" WHERE "Cupom"."clienteId" = '90c675d5-c5dc-462b-a68f-a10cfa96334c' AND "Cupom"."pesquisaId" = '87d63f62-4bb9-43e5-ab76-9eb004d4d2bb' ORDER BY "Cupom"."dataGeracao" DESC LIMIT 1;
Executing (default): SELECT "RoletaPremio"."id", "RoletaPremio"."tenantId", "RoletaPremio"."nome", "RoletaPremio"."descricao", "RoletaPremio"."probabilidade", "RoletaPremio"."recompensaId", "RoletaPremio"."roletaId", "RoletaPremio"."imageUrl", "RoletaPremio"."active", "RoletaPremio"."createdAt", "RoletaPremio"."updatedAt", "recompensa"."id" AS "recompensa.id", "recompensa"."tenantId" AS "recompensa.tenantId", "recompensa"."name" AS "recompensa.name", "recompensa"."description" AS "recompensa.description", "recompensa"."pointsRequired" AS "recompensa.pointsRequired", "recompensa"."type" AS "recompensa.type", "recompensa"."value" AS "recompensa.value", "recompensa"."imageUrl" AS "recompensa.imageUrl", "recompensa"."active" AS "recompensa.active", "recompensa"."createdAt" AS "recompensa.createdAt", "recompensa"."updatedAt" AS "recompensa.updatedAt" FROM "roleta_premios" AS "RoletaPremio" LEFT OUTER JOIN "recompensas" AS "recompensa" ON "RoletaPremio"."recompensaId" = "recompensa"."id" WHERE "RoletaPremio"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "RoletaPremio"."roletaId" = 'f40e45de-fb16-477d-b385-85eb9d38304c' ORDER BY "RoletaPremio"."nome" ASC;
Executing (default): INSERT INTO "cupons" ("id","pesquisaId","tenantId","recompensaId","codigo","clienteId","dataGeracao","dataValidade","status","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11) RETURNING "id","pesquisaId","tenantId","recompensaId","codigo","clienteId","dataGeracao","dataUtilizacao","dataValidade","status","ultimoContato","createdAt","updatedAt","campanhaId";
[RoletaController] Verificando se deve enviar mensagem de prêmio para o tenant 3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd.
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
[RoletaController] Todas as condições satisfeitas. Preparando para enviar a mensagem.
[RoletaController] Mensagem final: "Parabéns, Vo! Você ganhou um prêmio: 1 Esfiha Doce	. Use o cupom VO2648 para resgatar."
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
[WhatsApp Service] Iniciando envio para o tenant: 3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
[WhatsApp Service] Número original recebido: (35) 99165-7791
[WhatsApp Service] Número após normalização (dígitos + código do país): 5535991657791
[WhatsApp Service] Número final enviado para a API: 5535991657791@s.whatsapp.net
[WhatsApp Service] Falha ao enviar mensagem para o tenant 3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd. Número: (35) 99165-7791.
[WhatsApp Service] Erro detalhado da API: {
  "status": 400,
  "error": "Bad Request",
  "response": {
    "message": [
      {
        "exists": false,
        "jid": "5535991657791@s.whatsapp.net",
        "number": "5535991657791@s.whatsapp.net"
      }
    ]
  }
}
[RoletaController] Falha ao tentar enviar mensagem de prêmio via WhatsApp para o tenant 3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd. Erro: Request failed with status code 400
Executing (default): SELECT "id", "name", "logoUrl", "primaryColor", "secondaryColor", "description" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';