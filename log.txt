Postgres is up - executing command
Server.js is being executed!
API_KEY_ENCRYPTION_KEY is not defined in .env. Please set it for security.
Conexão com o banco de dados estabelecida com sucesso (Sequelize).
Server is running on port 5000
Agendador de relatório diário iniciado. A tarefa será executada todos os dias às 8:00.
Agendador de lembrete de cupons iniciado. A tarefa será executada todos os dias às 9:00.
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/recompensas?active=true
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/roletas
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
[Authorize Debug] User Role: Admin, Required: recompensas:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: recompensas, Action: read
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'recompensas' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
[Authorize Debug] User Role: Admin, Required: roletas:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: roletas, Action: read
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'roletas' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT "id", "tenantId", "name", "description", "pointsRequired", "type", "value", "imageUrl", "active", "createdAt", "updatedAt" FROM "recompensas" AS "Recompensa" WHERE "Recompensa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' AND "Recompensa"."active" = true ORDER BY "Recompensa"."name" ASC;
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT "id", "tenantId", "nome", "descricao", "active", "createdAt", "updatedAt" FROM "roletas" AS "Roleta" WHERE "Roleta"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/campanhas
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): INSERT INTO "campanhas" ("id","tenantId","nome","mensagem","rewardType","recompensaId","roletaId","dataValidade","criterioSelecao","status","messageDelaySeconds","createdAt","updatedAt") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13) RETURNING "id","tenantId","nome","mensagem","rewardType","recompensaId","roletaId","dataValidade","criterioSelecao","status","startDate","endDate","messageDelaySeconds","createdAt","updatedAt";
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/clients?page=1&limit=10&orderBy=name&order=asc&filter=
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "Client"."id", count(*) AS "count" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id";
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt", (
              SELECT MAX("createdAt")
              FROM "respostas" AS "r"
              WHERE "r"."respondentSessionId" = "Client"."respondentSessionId"
            ) AS "lastVisit" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id" ORDER BY "Client"."name" ASC LIMIT 10 OFFSET 0;
[Auth Middleware] Request: DELETE /api/clients/e4a34a27-16e4-4d0d-b872-f3023765fcdf
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): DELETE FROM "clients" WHERE "id" = 'e4a34a27-16e4-4d0d-b872-f3023765fcdf' AND "tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd'
[Auth Middleware] Request: GET /api/clients?page=1&limit=10&orderBy=name&order=asc&filter=
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "Client"."id", count(*) AS "count" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id";
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt", (
              SELECT MAX("createdAt")
              FROM "respostas" AS "r"
              WHERE "r"."respondentSessionId" = "Client"."respondentSessionId"
            ) AS "lastVisit" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id" ORDER BY "Client"."name" ASC LIMIT 10 OFFSET 0;
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/clients?page=1&limit=10&orderBy=name&order=asc&filter=
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "Client"."id", count(*) AS "count" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id";
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt", (
              SELECT MAX("createdAt")
              FROM "respostas" AS "r"
              WHERE "r"."respondentSessionId" = "Client"."respondentSessionId"
            ) AS "lastVisit" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' GROUP BY "Client"."id" ORDER BY "Client"."name" ASC LIMIT 10 OFFSET 0;
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/whatsapp-config/instance
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
[DEBUG] Evolution API connectionState response for roma-pizzaria--chopperiaaa: {
  instance: { instanceName: 'roma-pizzaria--chopperiaaa', state: 'open' }
}
[DEBUG] Interpreted newStatus for roma-pizzaria--chopperiaaa: connected
[DEBUG] instanceStatus for roma-pizzaria--chopperiaaa is already connected. No update needed.
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/whatsapp-config/instance
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
[DEBUG] Evolution API connectionState response for roma-pizzaria--chopperiaaa: {
  instance: { instanceName: 'roma-pizzaria--chopperiaaa', state: 'open' }
}
[DEBUG] Interpreted newStatus for roma-pizzaria--chopperiaaa: connected
[DEBUG] instanceStatus for roma-pizzaria--chopperiaaa is already connected. No update needed.
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/automations
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/roletas
[Auth Middleware] Request: GET /api/recompensas
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "url", "apiKey", "instanceName", "instanceStatus", "tenantId", "sendPrizeMessage", "prizeMessageTemplate", "dailyReportEnabled", "reportPhoneNumbers", "birthdayAutomationEnabled", "birthdayMessageTemplate", "birthdayDaysBefore", "birthdayRewardType", "birthdayRewardId", "birthdayCouponValidityDays", "createdAt", "updatedAt" FROM "whatsapp_configs" AS "WhatsappConfig" WHERE "WhatsappConfig"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
Executing (default): SELECT "id", "name", "description", "isSystemRole", "createdAt", "updatedAt" FROM "roles" AS "Role" WHERE "Role"."name" = 'Admin';
[Authorize Debug] User Role: Admin, Required: roletas:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: roletas, Action: read
Executing (default): SELECT "id", "tenantId", "type", "isEnabled", "daysBefore", "message", "createdAt", "updatedAt" FROM "whatsapp_templates" AS "WhatsappTemplate" WHERE "WhatsappTemplate"."type" = 'COUPON_REMINDER' AND "WhatsappTemplate"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' LIMIT 1;
[Authorize Debug] User Role: Admin, Required: recompensas:read
[Authorize Debug] Role ID: ce609d07-d83f-4002-a892-e17c91b767d3, Module: recompensas, Action: read
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'roletas' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
Executing (default): SELECT "RolePermissao"."roleId", "RolePermissao"."permissaoId", "RolePermissao"."createdAt", "RolePermissao"."updatedAt", "permissao"."id" AS "permissao.id", "permissao"."module" AS "permissao.module", "permissao"."action" AS "permissao.action", "permissao"."description" AS "permissao.description", "permissao"."createdAt" AS "permissao.createdAt", "permissao"."updatedAt" AS "permissao.updatedAt" FROM "role_permissoes" AS "RolePermissao" INNER JOIN "permissoes" AS "permissao" ON "RolePermissao"."permissaoId" = "permissao"."id" AND "permissao"."module" = 'recompensas' AND "permissao"."action" = 'read' WHERE "RolePermissao"."roleId" = 'ce609d07-d83f-4002-a892-e17c91b767d3';
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT "id", "tenantId", "nome", "descricao", "active", "createdAt", "updatedAt" FROM "roletas" AS "Roleta" WHERE "Roleta"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Authorize Debug] Has Permission Result: true
Executing (default): SELECT "id", "tenantId", "name", "description", "pointsRequired", "type", "value", "imageUrl", "active", "createdAt", "updatedAt" FROM "recompensas" AS "Recompensa" WHERE "Recompensa"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd' ORDER BY "Recompensa"."name" ASC;
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas?tenantId=3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: POST /api/campanhas/df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd/process
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): UPDATE "campanhas" SET "status"=$1,"updatedAt"=$2 WHERE "id" = $3 AND "tenantId" = $4
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Campanha] Iniciando processamento para campanha df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "name", "email", "phone", "birthDate", "respondentSessionId", "gender", "createdAt", "updatedAt" FROM "clients" AS "Client" WHERE "Client"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): UPDATE "campanhas" SET "status"=$1,"updatedAt"=$2 WHERE "id" = $3 AND "tenantId" = $4
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Campanha] Processamento da campanha df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd concluído com sucesso.
[Auth Middleware] Request: POST /api/auth/verify-token
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas/df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
[Auth Middleware] Request: GET /api/campanhas/df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd
Executing (default): SELECT "id", "name", "address", "phone", "email", "logoUrl", "primaryColor", "secondaryColor", "description", "website", "cnpj", "inscricaoEstadual", "reportPhoneNumber", "createdAt", "updatedAt" FROM "tenants" AS "Tenant" WHERE "Tenant"."id" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';
Executing (default): SELECT "id", "tenantId", "nome", "mensagem", "rewardType", "recompensaId", "roletaId", "dataValidade", "criterioSelecao", "status", "startDate", "endDate", "messageDelaySeconds", "createdAt", "updatedAt" FROM "campanhas" AS "Campanha" WHERE "Campanha"."id" = 'df286ccc-17e4-40ae-ab70-e1d8cbd1c6cd' AND "Campanha"."tenantId" = '3bd5b49a-56e6-45b7-9710-8d51b8f6e8dd';